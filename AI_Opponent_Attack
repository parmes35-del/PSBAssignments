import tkinter as tk
import random
import datetime


class Player:
    def __init__(self, name, hp, atk, def_):
        self.name = name
        self.hp = hp
        self.atk = atk
        self.def_ = def_
        self.experience = 0
        self.level = 1

    def attack(self, opponent):
        damage = (self.atk - opponent.def_) + random.randint(5, 10)
        damage = max(damage, 0)

        opponent.hp -= damage
        self.gain_experience(damage, opponent.def_)
        self.log_event("Attack", self.name, opponent.name, damage)

        return damage

    def gain_experience(self, damage, opponent_def):
        if damage == opponent_def:
            self.experience += 10
        elif damage > opponent_def:
            self.experience += 20

        while self.experience >= self.level_up_threshold():
            self.level_up()

    def level_up(self):
        self.level += 1
        self.hp += 10
        self.atk += 2
        self.def_ += 1
        self.log_event("Level Up", self.name, "", 0)

    def level_up_threshold(self):
        return 100

    def is_alive(self):
        return self.hp > 0

    def log_event(self, action_type, actor_name, target_name, value):
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        with open("event_log.txt", "a") as log_file:
            log_file.write(f"{timestamp} | {action_type}: {actor_name} -> {target_name}, Value: {value}\n")


class AIPlayer(Player):
    def attack(self, opponent):
        # Simple AI logic for attack decision
        damage = (self.atk - opponent.def_) + random.randint(5, 10)
        damage = max(damage, 0)

        opponent.hp -= damage
        self.gain_experience(damage, opponent.def_)
        self.log_event("AI Attack", self.name, opponent.name, damage)

        return damage


class Game:
    def __init__(self, master):
        self.master = master
        self.master.title("Turn-Based Battle Game")

        self.player1 = Player("Player 1", 100, 20, 5)
        self.player2 = AIPlayer("AI Player", 100, 15, 10)

        self.current_attacker = self.player1

        self.info_label = tk.Label(master, text=self.status_message())
        self.info_label.pack(pady=20)

        self.attack_button = tk.Button(master, text="Attack", command=self.attack)
        self.attack_button.pack(pady=10)

        self.restart_button = tk.Button(master, text="Restart", command=self.restart)
        self.restart_button.pack(pady=10)
        self.restart_button.config(state=tk.DISABLED)

    def status_message(self):
        return (f"{self.player1.name} HP: {self.player1.hp} | Level: {self.player1.level} | "
                f"{self.player2.name} HP: {self.player2.hp} | Level: {self.player2.level}")

    def attack(self):
        if self.current_attacker.is_alive():
            opponent = self.player2 if self.current_attacker == self.player1 else self.player1
            damage = self.current_attacker.attack(opponent)
            opponent_name = opponent.name

            self.info_label.config(text=f"{self.current_attacker.name} attacks {opponent_name} for {damage} damage!")

            if opponent.hp <= 0:
                opponent.hp = 0
                self.info_label.config(text=f"{opponent_name} has been defeated!")

            if not self.player1.is_alive() or not self.player2.is_alive():
                winner = self.player1 if self.player1.is_alive() else self.player2
                self.info_label.config(text=f"{winner.name} wins!")
                self.attack_button.config(state=tk.DISABLED)
                self.restart_button.config(state=tk.NORMAL)
            else:
                self.current_attacker = self.player2 if self.current_attacker == self.player1 else self.player1
                self.ai_attack()

    def ai_attack(self):
        if self.current_attacker.is_alive():
            damage = self.current_attacker.attack(self.player1)
            self.info_label.config(text=f"{self.current_attacker.name} attacks for {damage} damage!")

            if not self.player1.is_alive():
                winner = self.player2
                self.info_label.config(text=f"{winner.name} wins!")
                self.attack_button.config(state=tk.DISABLED)
                self.restart_button.config(state=tk.NORMAL)
            else:
                self.current_attacker = self.player1  # Switch turn back to player

    def restart(self):
        self.player1.hp = 100
        self.player2.hp = 100
        self.player1.experience = 0
        self.player2.experience = 0
        self.player1.level = 1
        self.player2.level = 1
        self.current_attacker = self.player1
        self.info_label.config(text=self.status_message())
        self.attack_button.config(state=tk.NORMAL)
        self.restart_button.config(state=tk.DISABLED)


if __name__ == "__main__":
    root = tk.Tk()
    game = Game(root)
    root.mainloop()
